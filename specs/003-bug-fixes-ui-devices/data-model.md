# Data Model: Bug Fixes — UI Theming, Command Execution & Device Management

**Feature**: `003-bug-fixes-ui-devices`  
**Date**: 2026-02-11

## Entity: Device

Represents a physical Android device tracked by the application. Persisted across sessions in a Rust-managed JSON registry.

### Fields

| Field | Type | Required | Description |
|---|---|---|---|
| `serial` | string | Yes | ADB serial number. Primary key. Unique identifier. Examples: `"abc123"` (USB), `"192.168.1.5:5555"` (wireless) |
| `status` | DeviceStatus | Yes | Current connection status. One of: `"device"`, `"offline"`, `"unauthorized"`, `"disconnected"` |
| `model` | string or null | No | Device model name from `ro.product.model`. Cached from last successful query. Example: `"Pixel 7"` |
| `android_version` | string or null | No | Android version from `ro.build.version.release`. Cached. Example: `"14"` |
| `battery_level` | integer or null | No | Battery percentage (0–100). Cached from last successful query. |
| `is_wireless` | boolean | Yes | Whether this is a wireless connection. Determined by `serial.contains(':')` |
| `last_seen` | ISO 8601 string or null | No | Timestamp of last time device was seen by ADB. Updated on every `list_devices` where device is present. |
| `first_seen` | ISO 8601 string | Yes | Timestamp of when the device was first added to the registry. |

### DeviceStatus (union type)

| Value | Source | Meaning | Allow Mirror? |
|---|---|---|---|
| `"device"` | ADB output | Fully connected and authorized | Yes |
| `"offline"` | ADB output | Physically present but ADB daemon not responding | No |
| `"unauthorized"` | ADB output | USB debugging not authorized on device | No |
| `"disconnected"` | App-synthetic | Not present in ADB output; previously known | No |

### Validation Rules
- `serial` must be non-empty and unique within the registry.
- `status` must be one of the four allowed values.
- `battery_level`, if present, must be in range 0–100.
- `last_seen` and `first_seen` must be valid ISO 8601 timestamps.
- `model` and `android_version` are cached — they are only updated when `status === "device"`.

### State Transitions

```
                    ┌──────────────┐
    first discovery │  (new entry) │
    ───────────────►│   "device"   │
                    └──────┬───────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
        ▼                  ▼                  ▼
  ┌──────────┐     ┌────────────┐    ┌──────────────┐
  │ "offline" │     │"unauthorized"│    │"disconnected"│
  └─────┬────┘     └──────┬─────┘    └──────┬───────┘
        │                 │                  │
        └─────────────────┼──────────────────┘
                          │
                          ▼
                    ┌──────────┐
                    │ "device" │  (reconnected)
                    └──────────┘

    Any status ──── "Forget" action ────► (removed from registry)
```

### Relationships
- **Device → Device Settings**: One-to-one. Keyed by `serial`. Settings persist independently in localStorage (frontend). A device can exist without settings (defaults used) and settings can exist without a device (orphaned after "Forget" — cleaned up lazily).
- **Device → Device Name**: One-to-one optional. Stored in `deviceNames` localStorage map (keyed by `serial`). Will be migrated to live inside Device Settings to eliminate dual-source.

---

## Entity: Device Settings (existing — changes noted)

Per-device scrcpy configuration. Already exists in `src/types/scrcpy.ts` as `DeviceSettings`. No structural changes needed.

### Changes from Current Implementation
| Change | Before | After |
|---|---|---|
| Name field sourcing | Dual-sourced: `deviceNames` map + `settings.name` | Single source: `settings.name` only. `deviceNames` map deprecated. |
| Persistence trigger | Only on "Launch" click | On modal close (any close path) + on "Launch" click |

---

## Entity: Scrcpy Command Args (new — replaces ScrcpyConfig)

Represents the command-line arguments for a scrcpy session. Generated by a single `buildArgs()` function.

### Fields

| Field | Type | Description |
|---|---|---|
| `serial` | string | Target device serial. Passed separately for process tracking. |
| `args` | string[] | Array of command-line argument strings. Example: `["--max-fps", "60", "--window-title", "My Phone"]` |

### Derivation Rules (from DeviceSettings)
- Each flag is a pair of elements: `["--flag", "value"]` or a single boolean flag: `["--flag"]`.
- Default values are omitted (e.g., bitrate 8000000 is scrcpy's default — don't pass `-b`).
- Contextual guards applied:
  - Camera mode (`videoSource === "camera"`): suppress `--display-id`, `--crop`, `--orientation`
  - Virtual display mode (`virtualDisplay` enabled): suppress `--display-id`, `--crop`
  - **Control-disabled** (`videoSource === "camera" || noControl`): suppress `--turn-screen-off`, `--show-touches`, `--power-off-on-close`, `--stay-awake`, `--start-app`. Note: `--no-power-on` is NOT suppressed (safe without control).
  - OTG mode: emit only `--otg` and return early
- Values with spaces are preserved as-is in the array (no quoting needed for execution; display formatter adds quoting).

---

## Entity: Theme (existing — changes noted)

Application visual theme. Already defined as `type Theme = "light" | "dark" | "system"`.

### Changes from Current Implementation
| Change | Before | After |
|---|---|---|
| `color-scheme` CSS property | Not set | Set dynamically: `"dark"` or `"light"` |
| Initial theme application | React `useEffect` (after first paint) | Synchronous `<script>` in `<head>` (before first paint) + React `useEffect` for full application |
| OS theme change listener | None | `matchMedia('(prefers-color-scheme: dark)')` change listener when `theme === "system"` |
| CSS hardcoded colors | Multiple hardcoded light-only values | All replaced with `var()` references to theme-aware custom properties |

### CSS Custom Properties — Complete Set

| Variable | `:root` Default | Light Value | Dark Value | Purpose |
|---|---|---|---|---|
| `--background` | (light gradient) | `linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)` | `linear-gradient(135deg, #1e293b 0%, #334155 100%)` | Page background |
| `--surface` | `rgba(255,255,255,0.95)` | same | `rgba(30,41,59,0.95)` | Card/panel backgrounds |
| `--text-primary` | `#1f2937` | same | `#f1f5f9` | Primary text |
| `--text-secondary` | `#6b7280` | same | `#94a3b8` | Secondary text |
| `--border-color` | **`#e5e7eb` (NEW in :root)** | same | `#475569` | All borders |
| `--input-bg` | **`white` (NEW in :root)** | same | `rgba(30,41,59,0.95)` | Input/select backgrounds |
| `--error-color` | `#ef4444` | same | `#f87171` | Error states (theme-aware) |
| `--error-bg` | **NEW** | `#fee2e2` | `rgba(239,68,68,0.15)` | Error alert backgrounds |
| `--error-text` | **NEW** | `#dc2626` | `#fca5a5` | Error alert text |
| `--error-border` | **NEW** | `#fecaca` | `rgba(239,68,68,0.3)` | Error alert borders |
| `--separator-color` | **NEW** | `rgba(0,0,0,0.1)` | `rgba(255,255,255,0.1)` | Log entry separators, section dividers |

---

## Storage Summary

| Data | Location | Format | Managed By |
|---|---|---|---|
| Device registry | `{app_data_dir}/devices.json` | JSON array of Device objects | Rust backend |
| Device settings | `localStorage["deviceSettings"]` | JSON array of `[serial, DeviceSettings]` tuples | Frontend (React) |
| Device names | `localStorage["deviceSettings"]` | Embedded in DeviceSettings `.name` field | Frontend (React) — migrate away from separate `deviceNames` key |
| Theme preference | `localStorage["scrcpy-theme"]` | Plain string | Frontend |
| Color scheme | `localStorage["scrcpy-colorScheme"]` | Plain string | Frontend |
| Font size | `localStorage["scrcpy-fontSize"]` | Plain string | Frontend |
| Presets | `localStorage["scrcpy-presets"]` | JSON array | Frontend |
