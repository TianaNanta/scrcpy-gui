name: Build and Release Cross-Platform Installers

on:
  push:
    tags:
      - "v*"
      - "release-*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (overrides tag_name when manually dispatching)"
        required: false
      release_name:
        description: "Release display name (optional)"
        required: false
      prerelease:
        description: "Mark release as prerelease (true/false)"
        required: false
        default: "false"

concurrency:
  group: build-and-release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux packages (DEB, RPM, AppImage)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bun (latest)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install JS dependencies with bun
        run: bun install

      - name: Build Linux packages
        run: |
          echo "Running production Linux build"
          bun run tauri build
        env:
          CI: "true"

      - name: Show built files (for debugging)
        run: |
          echo "=== Linux bundle files ==="
          ls -la src-tauri/target/release/bundle/deb || true
          ls -la src-tauri/target/release/bundle/rpm || true
          ls -la src-tauri/target/release/bundle/appimage || true

      - name: Upload build artifacts for release job
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/rpm/*.rpm
            src-tauri/target/release/bundle/appimage/*.AppImage

  build-windows:
    name: Build NSIS installer (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bun (latest)
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install JS dependencies with bun
        run: |
          bun install
        shell: bash

      - name: Build NSIS installer
        run: |
          echo "Running production NSIS build"
          bun run build:nsis
        shell: bash
        env:
          CI: "true"

      - name: Show built files (for debugging)
        run: |
          echo "=== Top-level files ==="
          ls -la || true
          echo "=== Tauri bundle directories ==="
          ls -la src-tauri/target/release/bundle/nsis || true
          ls -la src-tauri/target/release/bundle/msi || true
          echo "=== Specific target files ==="
          echo "NSIS .msi files:"
          ls -la src-tauri/target/release/bundle/nsis/*.exe 2>/dev/null || echo "(none)"
          echo "MSI .exe files:"
          ls -la src-tauri/target/release/bundle/msi/*.msi 2>/dev/null || echo "(none)"
        shell: bash

      - name: Upload build artifacts for release job
        uses: actions/upload-artifact@v4
        with:
          name: nsis-build
          # upload Tauri bundle outputs (NSIS/MSI) plus typical installer/archive patterns; adjust if your build emits to a different path
          path: |
            src-tauri/target/release/bundle/nsis/*.exe
            src-tauri/target/release/bundle/msi/*.msi

  create-release:
    name: Create GitHub Release and attach assets
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nsis-build
          path: release-assets

      - name: Download Linux build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: release-assets

      - name: List release-assets
        run: |
          echo "Files included for release upload:"
          find release-assets -type f -maxdepth 4 -print || true

      - name: Ensure release assets exist
        run: |
          echo "Checking for installer assets..."
          # Count installer files under release-assets
          EXE_COUNT=$(find release-assets -type f -name '*.exe' | wc -l || true)
          MSI_COUNT=$(find release-assets -type f -name '*.msi' | wc -l || true)
          DEB_COUNT=$(find release-assets -type f -name '*.deb' | wc -l || true)
          RPM_COUNT=$(find release-assets -type f -name '*.rpm' | wc -l || true)
          APPIMAGE_COUNT=$(find release-assets -type f -name '*.AppImage' | wc -l || true)
          echo "Found ${EXE_COUNT} .exe, ${MSI_COUNT} .msi, ${DEB_COUNT} .deb, ${RPM_COUNT} .rpm, ${APPIMAGE_COUNT} .AppImage files"
          TOTAL=$((EXE_COUNT + MSI_COUNT + DEB_COUNT + RPM_COUNT + APPIMAGE_COUNT))
          if [ "${TOTAL}" -eq 0 ]; then
            echo "No installer files found in release-assets; aborting release."
            exit 1
          fi
        shell: bash

      - name: Create GitHub release and upload assets
        # This action will create a release (based on tag) and upload installer files found under release-assets.
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release-assets/nsis/*.exe
            release-assets/msi/*.msi
            release-assets/deb/*.deb
            release-assets/rpm/*.rpm
            release-assets/appimage/*.AppImage
          tag_name: ${{ github.event.inputs.tag || github.ref_name }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.tag || github.ref_name }}
          prerelease: ${{ github.event.inputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-artifact:
    name: Persist installers as workflow artifact (optional)
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nsis-build
          path: persisted-assets/windows

      - name: Download Linux build artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: persisted-assets/linux

      - name: Upload as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: cross-platform-installers
          path: persisted-assets/**
